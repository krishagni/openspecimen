<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet author="vpawar" id="Clear the specimen custom fields record IDs">
    <sql>delete from os_spmn_cust_fields</sql>
  </changeSet>

  <changeSet author="vpawar" id="Specimen custom fields rec IDs">
    <sql>
      insert into
        os_spmn_cust_fields (specimen_id, form_id, record_id, form_ctxt_id)
      select
        re.object_id as specimen_id, fc.container_id as form_id, re.record_id as record_id, fc.identifier as form_ctxt_id
      from
        catissue_form_record_entry re
        inner join catissue_form_context fc on fc.identifier = re.form_ctxt_id
      where
        fc.entity_type = 'SpecimenExtension' and
        fc.deleted_on is null and
        re.activity_status = 'ACTIVE'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Clear the visit custom fields record IDs">
    <sql>delete from os_visit_cust_fields</sql>
  </changeSet>

  <changeSet author="vpawar" id="Visit custom fields rec IDs">
    <sql>
      insert into
        os_visit_cust_fields (visit_id, form_id, record_id, form_ctxt_id)
      select
        re.object_id as visit_id, fc.container_id as form_id, re.record_id as record_id, fc.identifier as form_ctxt_id
      from
        catissue_form_record_entry re
        inner join catissue_form_context fc on fc.identifier = re.form_ctxt_id
      where
        fc.entity_type = 'VisitExtension' and
        fc.deleted_on is null and
        re.activity_status = 'ACTIVE'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Clear the participant registration custom fields record IDs">
    <sql>delete from os_cpr_cust_fields</sql>
  </changeSet>

  <changeSet author="vpawar" id="Participant registration custom fields rec IDs">
    <sql>
      insert into
        os_cpr_cust_fields (cpr_id, form_id, record_id, form_ctxt_id)
      select
        re.object_id as cpr_id, fc.container_id as form_id, re.record_id as record_id, fc.identifier as form_ctxt_id
      from
        catissue_form_record_entry re
        inner join catissue_form_context fc on fc.identifier = re.form_ctxt_id
      where
        fc.entity_type = 'ParticipantExtension' and
        fc.deleted_on is null and
        re.activity_status = 'ACTIVE'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Clear the CP custom fields record IDs">
    <sql>delete from os_cp_cust_fields</sql>
  </changeSet>

  <changeSet author="vpawar" id="CP custom fields rec IDs">
    <sql>
      insert into
        os_cp_cust_fields (cp_id, form_id, record_id, form_ctxt_id)
      select
        re.object_id as cp_id, fc.container_id as form_id, re.record_id as record_id, fc.identifier as form_ctxt_id
      from
        catissue_form_record_entry re
        inner join catissue_form_context fc on fc.identifier = re.form_ctxt_id
      where
        fc.entity_type = 'CollectionProtocolExtension' and
        fc.deleted_on is null and
        re.activity_status = 'ACTIVE'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Clear the Order custom fields record IDs">
    <sql>delete from os_order_cust_fields</sql>
  </changeSet>

  <changeSet author="vpawar" id="Order custom fields rec IDs">
    <sql>
      insert into
        os_order_cust_fields (order_id, form_id, record_id, form_ctxt_id)
      select
        re.object_id as order_id, fc.container_id as form_id, re.record_id as record_id, fc.identifier as form_ctxt_id
      from
        catissue_form_record_entry re
        inner join catissue_form_context fc on fc.identifier = re.form_ctxt_id
      where
        fc.entity_type = 'OrderExtension' and
        fc.deleted_on is null and
        re.activity_status = 'ACTIVE'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Associate object type and ID for every uploaded file of custom forms" dbms="mysql">
    <sql>
      update
        dyextn_form_files file
        inner join catissue_form_record_entry re on re.record_id = file.record_id
        inner join catissue_form_context fc on fc.identifier = re.form_ctxt_id and fc.container_id = file.form_id
      set
        file.object_type = fc.entity_type,
        file.object_id = re.object_id
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Associate object type and ID for every uploaded file of custom forms" dbms="oracle">
    <sql>
      merge into
        dyextn_form_files fl
      using (
        select
          fc.container_id as form_id, re.record_id as record_id, fc.entity_type as object_type, re.object_id as object_id
        from
          catissue_form_context fc
          inner join catissue_form_record_entry re on re.form_ctxt_id = fc.identifier
      ) t on (t.form_id = fl.form_id and t.record_id = fl.record_id)
      when matched then
        update set
          fl.object_type = t.object_type,
          fl.object_id = t.object_id
    </sql>
  </changeSet>

  <!-- changeSet author="vpawar" id="Record entry table backup">
    <sql>
      create table catissue_fre_20251114 as select * from catissue_form_record_entry
    </sql>
  </changeSet -->

  <changeSet author="vpawar" id="Delete specimen custom field records from the centralised records entry table">
    <sql>
      delete from
        catissue_form_record_entry
      where
        form_ctxt_id in (
          select
            identifier
          from
            catissue_form_context
          where
            entity_type in (
              'CollectionProtocolExtension',
              'ParticipantExtension',
              'VisitExtension',
              'SpecimenExtension',
              'OrderExtension'
            )
        )
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Move specimen collection details from a separate table to the owning entity table" dbms="mysql">
    <sql>
      update
        catissue_specimen s
        inner join catissue_coll_event_param ce on ce.specimen_id = s.identifier
      set
        s.collection_container_id = ce.collection_container_id,
        s.collection_procedure_id = ce.collection_procedure_id,
        s.collection_user_id = ce.user_id,
        s.collection_time = ce.event_timestamp,
        s.collection_comments = ce.comments
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Move specimen collection details from a separate table to the owning entity table" dbms="oracle">
    <sql>
      merge into
        catissue_specimen s
      using (
        select
          specimen_id, collection_container_id, collection_procedure_id, user_id, event_timestamp, comments
        from
          catissue_coll_event_param
      ) ce on (ce.specimen_id = s.identifier)
      when matched then
        update set
          s.collection_container_id = ce.collection_container_id,
          s.collection_procedure_id = ce.collection_procedure_id,
          s.collection_user_id = ce.user_id,
          s.collection_time = ce.event_timestamp,
          s.collection_comments = ce.comments
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Move specimen received details from a separate table to the owning entity table" dbms="mysql">
    <sql>
      update
        catissue_specimen s
        inner join catissue_received_event_param re on re.specimen_id = s.identifier
      set
        s.received_quality_id = re.received_quality_id,
        s.received_user_id = re.user_id,
        s.received_time = re.event_timestamp,
        s.received_comments = re.comments
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Move specimen received details from a separate table to the owning entity table" dbms="oracle">
    <sql>
      merge into
        catissue_specimen s
      using (
        select
          specimen_id, received_quality_id, user_id, event_timestamp, comments
        from
          catissue_received_event_param
      ) re on (re.specimen_id = s.identifier)
      when matched then
        update set
          s.received_quality_id = re.received_quality_id,
          s.received_user_id = re.user_id,
          s.received_time = re.event_timestamp,
          s.received_comments = re.comments
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Replace the specimen collection and received form field columns with the main entity columns in the saved queries">
    <sql>
      update
        catissue_saved_queries
      set
        query_def =
          replace(
            replace(
              replace(
                replace(
                  replace(
                    replace(
                      replace(
                        replace(
                          replace(
                            replace(
                              replace(
                                replace(
                                  replace(
                                    query_def,
                                    'Specimen.extensions.SpecimenCollectionEvent._?primary_key?_',
                                    'Specimen.id'
                                  ),
                                  'Specimen.extensions.SpecimenCollectionEvent.procedure',
                                  'Specimen.spmnCollRecvDetails.collProcedure'
                                ),
                                'Specimen.extensions.SpecimenCollectionEvent.container',
                                'Specimen.spmnCollRecvDetails.collContainer'
                              ),
                              'Specimen.extensions.SpecimenCollectionEvent.user',
                              'Specimen.spmnCollRecvDetails.collector'
                            ),
                            'Specimen.extensions.SpecimenCollectionEvent.time',
                            'Specimen.spmnCollRecvDetails.collTime'
                          ),
                          'Specimen.extensions.SpecimenCollectionEvent.comments',
                          'Specimen.spmnCollRecvDetails.collComments'
                        ),
                        'Specimen.extensions.SpecimenCollectionEvent._rec_details_.status',
                        'Specimen.collectionStatus'
                      ),
                      'Specimen.extensions.SpecimenReceivedEvent._?primary_key?_',
                      'Specimen.id'
                    ),
                    'Specimen.extensions.SpecimenReceivedEvent.quality',
                    'Specimen.spmnCollRecvDetails.recvQuality'
                  ),
                  'Specimen.extensions.SpecimenReceivedEvent.user',
                  'Specimen.spmnCollRecvDetails.receiver'
                ),
                'Specimen.extensions.SpecimenReceivedEvent.time',
                'Specimen.spmnCollRecvDetails.recvTime'
              ),
              'Specimen.extensions.SpecimenReceivedEvent.comments',
              'Specimen.spmnCollRecvDetails.recvComments'
            ),
            'Specimen.extensions.SpecimenReceivedEvent._rec_details_.status',
            'Specimen.collectionStatus'
          )
      where
        query_def like '%Specimen.extensions.SpecimenCollectionEvent%' or
        query_def like '%Specimen.extensions.SpecimenReceivedEvent%'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Set the legacy flag to ON (True) for older SAML implementations">
    <sql>
      update
        os_auth_domains
      set
        legacy_saml = 1
      where
        identifier in (
          select
            t.legacy_saml_id
          from (
            select
              min(d.identifier) as legacy_saml_id
            from
              os_auth_domains d
              inner join os_auth_providers p on d.provider_id = p.identifier
            where
              d.activity_status != 'Disabled' and
              p.auth_type = 'saml'
          ) t
        )
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Update specimen label formats to use the correct field names for collection container/procedure and received quality">
    <sql>
      update
        catissue_collection_protocol
      set
        label_format = replace(label_format, 'specimen.collectionEvent.container', 'specimen.collectionContainer')
      where
        label_format like '%specimen.collectionEvent.container%'
    </sql>
    <sql>
      update
        catissue_collection_protocol
      set
        label_format = replace(label_format, 'specimen.collectionEvent.procedure', 'specimen.collectionProcedure')
      where
        label_format like '%specimen.collectionEvent.procedure%'
    </sql>
    <sql>
      update
        catissue_collection_protocol
      set
        label_format = replace(label_format, 'specimen.receivedEvent.quality', 'specimen.receivedQuality')
      where
        label_format like '%specimen.receivedEvent.quality%'
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Update specimen print rules to use the correct field names for collection container/procedure and received quality">
    <sql>
      update
        os_print_rules
      set
        rule_def = replace(rule_def, 'specimen.collectionEvent.container', 'specimen.collectionContainer')
      where
        rule_def like '%specimen.collectionEvent.container%'
    </sql>
    <sql>
      update
        os_print_rules
      set
        rule_def = replace(rule_def, 'specimen.collectionEvent.procedure', 'specimen.collectionProcedure')
      where
        rule_def like '%specimen.collectionEvent.procedure%'
    </sql>
    <sql>
      update
        os_print_rules
      set
        rule_def = replace(rule_def, 'specimen.receivedEvent.quality', 'specimen.receivedQuality')
      where
        rule_def like '%specimen.receivedEvent.quality%'
    </sql>
  </changeSet>
</databaseChangeLog>
