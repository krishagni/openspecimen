<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet author="vpawar" id="Move specimen units from PV properties to the PVs table">
    <customChange class="com.krishagni.catissueplus.core.upgrade.SpecimenUnitsLoader" />
  </changeSet>

  <changeSet author="vpawar" id="Migrate system level specimen type units from PV props - Part 1: Specimen Class" dbms="mysql">
    <sql>
      insert into
        os_specimen_type_units (specimen_class_id, quantity_unit_id, concentration_unit_id)
      select
        qu.identifier as specimen_class_id, qpv.identifier as quantity_unit_id, cpv.identifier as concentration_unit_id
      from
        (
          select
            sc.identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value sc
            left join os_pv_props unit on unit.pv_id = sc.identifier and unit.name = 'quantity_unit'
            left join os_pv_props sym on sym.pv_id = sc.identifier and sym.name = 'quantity_display_unit'
          where
            sc.public_id = 'specimen_type' and
            sc.parent_identifier is null
        ) qu left join (
          select
            sc.identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value sc
            left join os_pv_props unit on unit.pv_id = sc.identifier and unit.name = 'concentration_unit'
            left join os_pv_props sym on sym.pv_id = sc.identifier and sym.name = 'concentration_display_unit'
          where
            sc.public_id = 'specimen_type' and
            sc.parent_identifier is null
        ) cu on cu.identifier = qu.identifier
        left join catissue_permissible_value qpv on qpv.value = qu.unit and qpv.public_id = 'specimen_unit'
        left join catissue_permissible_value cpv on cpv.value = cu.unit and cpv.public_id = 'specimen_unit'
      where
        qpv.identifier is not null or cpv.identifier is not null
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Migrate system level specimen type units from PV props - Part 2: Specimen Type" dbms="mysql">
    <sql>
      insert into
        os_specimen_type_units (specimen_class_id, specimen_type_id, quantity_unit_id, concentration_unit_id)
      select
        qu.parent_identifier as specimen_class_id, qu.identifier as specimen_type_id, qpv.identifier as quantity_unit_id, cpv.identifier as concentration_unit_id
      from
        (
          select
            st.identifier, st.parent_identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value st
            left join os_pv_props unit on unit.pv_id = st.identifier and unit.name = 'quantity_unit'
            left join os_pv_props sym on sym.pv_id = st.identifier and sym.name = 'quantity_display_unit'
          where
            st.public_id = 'specimen_type' and
            st.parent_identifier is not null
        ) qu left join (
          select
            st.identifier, st.parent_identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value st
            left join os_pv_props unit on unit.pv_id = st.identifier and unit.name = 'concentration_unit'
            left join os_pv_props sym on sym.pv_id = st.identifier and sym.name = 'concentration_display_unit'
          where
            st.public_id = 'specimen_type' and
            st.parent_identifier is not null
        ) cu on cu.identifier = qu.identifier
        left join catissue_permissible_value qpv on qpv.value = qu.unit and qpv.public_id = 'specimen_unit'
        left join catissue_permissible_value cpv on cpv.value = cu.unit and cpv.public_id = 'specimen_unit'
      where
        qpv.identifier is not null or cpv.identifier is not null
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Migrate system level specimen type units from PV props - Part 1: Specimen Class" dbms="oracle">
    <sql>
      insert into
        os_specimen_type_units (identifier, specimen_class_id, quantity_unit_id, concentration_unit_id)
      select
        os_specimen_type_units_seq.nextval as identifier, qu.identifier as specimen_class_id, qpv.identifier as quantity_unit_id, cpv.identifier as concentration_unit_id
      from
        (
          select
            sc.identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value sc
            left join os_pv_props unit on unit.pv_id = sc.identifier and unit.name = 'quantity_unit'
            left join os_pv_props sym on sym.pv_id = sc.identifier and sym.name = 'quantity_display_unit'
          where
            sc.public_id = 'specimen_type' and
            sc.parent_identifier is null
        ) qu left join (
          select
            sc.identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value sc
            left join os_pv_props unit on unit.pv_id = sc.identifier and unit.name = 'concentration_unit'
            left join os_pv_props sym on sym.pv_id = sc.identifier and sym.name = 'concentration_display_unit'
          where
            sc.public_id = 'specimen_type' and
            sc.parent_identifier is null
        ) cu on cu.identifier = qu.identifier
        left join catissue_permissible_value qpv on qpv.value = qu.unit and qpv.public_id = 'specimen_unit'
        left join catissue_permissible_value cpv on cpv.value = cu.unit and cpv.public_id = 'specimen_unit'
      where
        qpv.identifier is not null or cpv.identifier is not null
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Migrate system level specimen type units from PV props - Part 2: Specimen Type" dbms="oracle">
    <sql>
      insert into
        os_specimen_type_units (identifier, specimen_class_id, specimen_type_id, quantity_unit_id, concentration_unit_id)
      select
        os_specimen_type_units_seq.nextval as identifier, qu.parent_identifier as specimen_class_id, qu.identifier as specimen_type_id, qpv.identifier as quantity_unit_id, cpv.identifier as concentration_unit_id
      from
        (
          select
            st.identifier, st.parent_identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value st
            left join os_pv_props unit on unit.pv_id = st.identifier and unit.name = 'quantity_unit'
            left join os_pv_props sym on sym.pv_id = st.identifier and sym.name = 'quantity_display_unit'
          where
            st.public_id = 'specimen_type' and
            st.parent_identifier is not null
        ) qu left join (
          select
            st.identifier, st.parent_identifier, case when sym.value is not null then sym.value else unit.value end as unit
          from
            catissue_permissible_value st
            left join os_pv_props unit on unit.pv_id = st.identifier and unit.name = 'concentration_unit'
            left join os_pv_props sym on sym.pv_id = st.identifier and sym.name = 'concentration_display_unit'
          where
            st.public_id = 'specimen_type' and
            st.parent_identifier is not null
        ) cu on cu.identifier = qu.identifier
        left join catissue_permissible_value qpv on qpv.value = qu.unit and qpv.public_id = 'specimen_unit'
        left join catissue_permissible_value cpv on cpv.value = cu.unit and cpv.public_id = 'specimen_unit'
      where
        qpv.identifier is not null or cpv.identifier is not null
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Temporary table to store all the specimen types' quantity and concentration units">
    <createTable tableName="OS_TMP_SPMN_UNITS">
      <column name="SPECIMEN_CLASS_ID" type="${int.type}" />
      <column name="SPECIMEN_TYPE_ID" type="${int.type}" />
      <column name="QUANTITY_UNIT_ID" type="${int.type}" />
      <column name="CONCENTRATION_UNIT_ID" type="${int.type}" />
    </createTable>
  </changeSet>

  <changeSet author="vpawar" id="Part 1: Initialise the quantity and concentration units that have been set at the specimen type level">
    <sql>
      insert into
        os_tmp_spmn_units (specimen_class_id, specimen_type_id, quantity_unit_id, concentration_unit_id)
      select
        sc.identifier as specimen_class_id, st.identifier as specimen_type_id,
        stu.quantity_unit_id as quantity_unit_id, stu.concentration_unit_id as concentration_unit_id
      from
        catissue_permissible_value sc
        inner join catissue_permissible_value st on st.parent_identifier = sc.identifier
        left join os_specimen_type_units stu on stu.specimen_class_id = sc.identifier and stu.specimen_type_id = st.identifier
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Part 2: Initialise the quantity and concentration units inherited from the specimen class level" dbms="mysql">
    <sql>
      update
        os_tmp_spmn_units tu
        inner join os_specimen_type_units stu on stu.specimen_class_id = tu.specimen_class_id and stu.specimen_type_id is null
      set
        tu.quantity_unit_id = case when tu.quantity_unit_id is null then stu.quantity_unit_id else tu.quantity_unit_id end,
        tu.concentration_unit_id = case when tu.concentration_unit_id is null then stu.concentration_unit_id else tu.concentration_unit_id end
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Part 2: Initialise the quantity and concentration units inherited from the specimen class level" dbms="oracle">
    <sql>
      merge into
        os_tmp_spmn_units tu
      using (
        select
          specimen_class_id, specimen_type_id, quantity_unit_id, concentration_unit_id
        from
          os_specimen_type_units
      ) stu on stu.specimen_class_id = tu.specimen_class_id and stu.specimen_type_id is null
      when matched then
        update set
          tu.quantity_unit_id = nvl(tu.quantity_unit_id, stu.quantity_unit_id),
          tu.concentration_unit_id = nvl(tu.concentration_unit_id, stu.concentration_unit_id)
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Index on specimen class and types of the computed quantity/concentration units">
    <createIndex tableName="OS_TMP_SPMN_UNITS" indexName="OS_TMP_SPMN_UNIT_CLS_TYPE_IDX">
      <column name="SPECIMEN_CLASS_ID" />
      <column name="SPECIMEN_TYPE_ID" />
    </createIndex>
  </changeSet>

  <changeSet author="vpawar" id="Initialise the specimen quantity and concentration units" dbms="mysql">
    <sql>
      update
        catissue_specimen s
        inner join os_tmp_spmn_units tu on tu.specimen_class_id = s.specimen_class_id and tu.specimen_type_id = s.specimen_type_id
      set
        s.quantity_unit_id = tu.quantity_unit_id,
        s.concentration_unit_id = tu.concentration_unit_id
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Initialise the specimen quantity and concentration units" dbms="oracle">
    <sql>
      merge into
        catissue_specimen s
      using (
        select
          specimen_class_id, specimen_type_id, quantity_unit_id, concentration_unit_id
        from
          os_tmp_spmn_units
      ) tu on tu.specimen_class_id = s.specimen_class_id and tu.specimen_type_id = s.specimen_type_id
      when matched
        update set
          s.quantity_unit_id = tu.quantity_unit_id,
          s.concentration_unit_id = tu.concentration_unit_id
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Initialise the specimen requirement quantity and concentration units" dbms="mysql">
    <sql>
      update
        catissue_cp_req_specimen s
        inner join os_tmp_spmn_units tu on tu.specimen_class_id = s.specimen_class_id and tu.specimen_type_id = s.specimen_type_id
      set
        s.quantity_unit_id = tu.quantity_unit_id,
        s.concentration_unit_id = tu.concentration_unit_id
    </sql>
  </changeSet>

  <changeSet author="vpawar" id="Initialise the specimen requirement quantity and concentration units" dbms="oracle">
    <sql>
      merge into
        catissue_cp_req_specimen s
      using (
        select
          specimen_class_id, specimen_type_id, quantity_unit_id, concentration_unit_id
        from
          os_tmp_spmn_units
      ) tu on tu.specimen_class_id = s.specimen_class_id and tu.specimen_type_id = s.specimen_type_id
      when matched
        update set
          s.quantity_unit_id = tu.quantity_unit_id,
          s.concentration_unit_id = tu.concentration_unit_id
    </sql>
  </changeSet>
</databaseChangeLog>